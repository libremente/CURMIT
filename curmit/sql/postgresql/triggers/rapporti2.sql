drop trigger trig_coimcimp_st on coimcimp;
create or replace function coimcimp_st_tr() returns trigger
as '
declare
st_ope coimaimp_st.st_operazione%TYPE;
begin
IF (TG_OP = ''DELETE'') THEN
	 st_ope := ''C'';
 END IF;
IF (TG_OP = ''UPDATE'') THEN
	 st_ope := ''M'';
 END IF;
--
IF (TG_OP = ''UPDATE'') THEN 
insert into coimcimp_st (
		cod_cimp,
		cod_impianto,
		cod_documento,
		gen_prog,
		cod_inco,
		data_controllo,
		verb_n,
		data_verb,
		cod_opve,
		costo,
		nominativo_pres,
		presenza_libretto,
		libretto_corretto,
		dich_conformita,
		libretto_manutenz,
		mis_port_combust,
		mis_pot_focolare,
		stato_coiben,
		stato_canna_fum,
		verifica_dispo,
		verifica_areaz,
		taratura_dispos,
		co_fumi_secchi,
		ppm,
		eccesso_aria_perc,
		perdita_ai_fumi,
		rend_comb_conv,
		rend_comb_min,
		temp_fumi_1a,
		temp_fumi_2a,
		temp_fumi_3a,
		temp_fumi_md,
		t_aria_comb_1a,
		t_aria_comb_2a,
		t_aria_comb_3a,
		t_aria_comb_md,
		temp_mant_1a,
		temp_mant_2a,
		temp_mant_3a,
		temp_mant_md,
		temp_h2o_out_1a,
		temp_h2o_out_2a,
		temp_h2o_out_3a,
		temp_h2o_out_md,
		co2_1a,
		co2_2a,
		co2_3a,
		co2_md,
		o2_1a,
		o2_2a,
		o2_3a,
		o2_md,
		co_1a,
		co_2a,
		co_3a,
		co_md,
		indic_fumosita_1a,
		indic_fumosita_2a,
		indic_fumosita_3a,
		indic_fumosita_md,
		manutenzione_8a,
		co_fumi_secchi_8b,
		indic_fumosita_8c,
		rend_comb_8d,
		esito_verifica,
		strumento,
		note_verificatore ,
		note_resp,
		note_conf,
		tipologia_costo,
		riferimento_pag,
		utente,
		data_ins,
		data_mod,
		pot_utile_nom,
		pot_focolare_nom, 
		cod_combustibile,
		cod_responsabile,
		flag_cpi,
		flag_ispes,
		flag_pericolosita,
		flag_tracciato,
		new1_data_dimp,
		new1_data_paga_dimp,
		new1_conf_locale,
		new1_conf_accesso,
		new1_pres_intercet,
		new1_pres_interrut,
		new1_asse_mate_estr,
		new1_pres_mezzi,
		new1_pres_cartell,
		new1_disp_regolaz,
		new1_foro_presente,
		new1_foro_corretto,
		new1_foro_accessibile,
		new1_canali_a_norma,
		new1_lavoro_nom_iniz,
		new1_lavoro_nom_fine,
		new1_lavoro_lib_iniz,
		new1_lavoro_lib_fine,
		new1_note_manu,
		new1_dimp_pres,
		new1_dimp_prescriz,
		new1_data_ultima_manu,
		new1_data_ultima_anal,
		new1_manu_prec_8a,
		new1_co_rilevato,
		new1_flag_peri_8p,
		flag_uso,
		flag_diffida,
		eccesso_aria_perc_2a,
		eccesso_aria_perc_3a,
		eccesso_aria_perc_md,
		n_prot,
		data_prot,
		sezioni_corr,
		curve_corr,
		lungh_corr,
		riflussi_loc,
		perdite_cond,
		disp_funz,
		assenza_fughe,
		effic_evac,
		autodich,
		dich_conf,
		manut_prog,
		marca_strum,
		modello_strum,
		matr_strum,
		dt_tar_strum,
		indice_aria,
		perd_cal_sens,
		doc_ispesl,
		doc_prev_incendi,
		libr_manut_bruc,
		ubic_locale_norma,
		disp_chius_porta,
		spazi_norma,
		apert_soffitto,
		rubin_manuale_acces,
		assenza_app_peric,
		rubin_chiuso,
		elettrovalv_esterne,
		tubaz_press,
		tolta_tensione,
		termost_esterno,
		chiusura_foro,
		accens_funz_gen,
		pendenza,
		ventilaz_lib_ostruz,
		disp_reg_cont_pre,
		disp_reg_cont_funz,
		disp_reg_clim_funz,
		conf_imp_elettrico,
		volumetria,
		comsumi_ultima_stag,
		ora_inizio,
		ora_fine,
		utente_ins,
		fl_firma_tecnico,
		fl_firma_resp,
		costo_nonreg,
		f_comunic_cess,
		stampe_analiz_alleg,
		fattore_molt,
		note_strum,
		prod_h2o_sanit,
		note_analisi_no_eff,
		altre_difformita,
		utente_pres,
		delegato_ragsoc,
		delegato_indirizzo,
		data_arrivo,
		note_esamevisivo_locale,
		flag_sbocco_tetto,
		flag_unicig_7129,
		new1_data_ultima_manu_2,
		new1_data_ultima_manu_3,
		new1_data_ultima_anal_2,
		new1_data_ultima_anal_3,
		new1_dimp_pres_2,
		new1_dimp_pres_3,
		trasf_centr_aut,
		igni_progressivo,
		scarico_tetto,
		scarico_parete,
--		st_progressivo,
		st_utente,
		st_operazione,
		st_data_validita)
	values (
		OLD.cod_cimp,
		OLD.cod_impianto,
		OLD.cod_documento,
		OLD.gen_prog,
		OLD.cod_inco,
		OLD.data_controllo,
		OLD.verb_n,
		OLD.data_verb,
		OLD.cod_opve,
		OLD.costo,
		OLD.nominativo_pres,
		OLD.presenza_libretto,
		OLD.libretto_corretto,
		OLD.dich_conformita,
		OLD.libretto_manutenz,
		OLD.mis_port_combust,
		OLD.mis_pot_focolare,
		OLD.stato_coiben,
		OLD.stato_canna_fum,
		OLD.verifica_dispo,
		OLD.verifica_areaz,
		OLD.taratura_dispos,
		OLD.co_fumi_secchi,
		OLD.ppm,
		OLD.eccesso_aria_perc,
		OLD.perdita_ai_fumi,
		OLD.rend_comb_conv,
		OLD.rend_comb_min,
		OLD.temp_fumi_1a,
		OLD.temp_fumi_2a,
		OLD.temp_fumi_3a,
		OLD.temp_fumi_md,
		OLD.t_aria_comb_1a,
		OLD.t_aria_comb_2a,
		OLD.t_aria_comb_3a,
		OLD.t_aria_comb_md,
		OLD.temp_mant_1a,
		OLD.temp_mant_2a,
		OLD.temp_mant_3a,
		OLD.temp_mant_md,
		OLD.temp_h2o_out_1a,
		OLD.temp_h2o_out_2a,
		OLD.temp_h2o_out_3a,
		OLD.temp_h2o_out_md,
		OLD.co2_1a,
		OLD.co2_2a,
		OLD.co2_3a,
		OLD.co2_md,
		OLD.o2_1a,
		OLD.o2_2a,
		OLD.o2_3a,
		OLD.o2_md,
		OLD.co_1a,
		OLD.co_2a,
		OLD.co_3a,
		OLD.co_md,
		OLD.indic_fumosita_1a,
		OLD.indic_fumosita_2a,
		OLD.indic_fumosita_3a,
		OLD.indic_fumosita_md,
		OLD.manutenzione_8a,
		OLD.co_fumi_secchi_8b,
		OLD.indic_fumosita_8c,
		OLD.rend_comb_8d,
		OLD.esito_verifica,
		OLD.strumento,
		OLD.note_verificatore ,
		OLD.note_resp,
		OLD.note_conf,
		OLD.tipologia_costo,
		OLD.riferimento_pag,
		OLD.utente,
		OLD.data_ins,
		OLD.data_mod,
		OLD.pot_utile_nom,
		OLD.pot_focolare_nom, 
		OLD.cod_combustibile,
		OLD.cod_responsabile,
		OLD.flag_cpi,
		OLD.flag_ispes,
		OLD.flag_pericolosita,
		OLD.flag_tracciato,
		OLD.new1_data_dimp,
		OLD.new1_data_paga_dimp,
		OLD.new1_conf_locale,
		OLD.new1_conf_accesso,
		OLD.new1_pres_intercet,
		OLD.new1_pres_interrut,
		OLD.new1_asse_mate_estr,
		OLD.new1_pres_mezzi,
		OLD.new1_pres_cartell,
		OLD.new1_disp_regolaz,
		OLD.new1_foro_presente,
		OLD.new1_foro_corretto,
		OLD.new1_foro_accessibile,
		OLD.new1_canali_a_norma,
		OLD.new1_lavoro_nom_iniz,
		OLD.new1_lavoro_nom_fine,
		OLD.new1_lavoro_lib_iniz,
		OLD.new1_lavoro_lib_fine,
		OLD.new1_note_manu,
		OLD.new1_dimp_pres,
		OLD.new1_dimp_prescriz,
		OLD.new1_data_ultima_manu,
		OLD.new1_data_ultima_anal,
		OLD.new1_manu_prec_8a,
		OLD.new1_co_rilevato,
		OLD.new1_flag_peri_8p,
		OLD.flag_uso,
		OLD.flag_diffida,
		OLD.eccesso_aria_perc_2a,
		OLD.eccesso_aria_perc_3a,
		OLD.eccesso_aria_perc_md,
		OLD.n_prot,
		OLD.data_prot,
		OLD.sezioni_corr,
		OLD.curve_corr,
		OLD.lungh_corr,
		OLD.riflussi_loc,
		OLD.perdite_cond,
		OLD.disp_funz,
		OLD.assenza_fughe,
		OLD.effic_evac,
		OLD.autodich,
		OLD.dich_conf,
		OLD.manut_prog,
		OLD.marca_strum,
		OLD.modello_strum,
		OLD.matr_strum,
		OLD.dt_tar_strum,
		OLD.indice_aria,
		OLD.perd_cal_sens,
		OLD.doc_ispesl,
		OLD.doc_prev_incendi,
		OLD.libr_manut_bruc,
		OLD.ubic_locale_norma,
		OLD.disp_chius_porta,
		OLD.spazi_norma,
		OLD.apert_soffitto,
		OLD.rubin_manuale_acces,
		OLD.assenza_app_peric,
		OLD.rubin_chiuso,
		OLD.elettrovalv_esterne,
		OLD.tubaz_press,
		OLD.tolta_tensione,
		OLD.termost_esterno,
		OLD.chiusura_foro,
		OLD.accens_funz_gen,
		OLD.pendenza,
		OLD.ventilaz_lib_ostruz,
		OLD.disp_reg_cont_pre,
		OLD.disp_reg_cont_funz,
		OLD.disp_reg_clim_funz,
		OLD.conf_imp_elettrico,
		OLD.volumetria,
		OLD.comsumi_ultima_stag,
		OLD.ora_inizio,
		OLD.ora_fine,
		OLD.utente_ins,
		OLD.fl_firma_tecnico,
		OLD.fl_firma_resp,
		OLD.costo_nonreg,
		OLD.f_comunic_cess,
		OLD.stampe_analiz_alleg,
		OLD.fattore_molt,
		OLD.note_strum,
		OLD.prod_h2o_sanit,
		OLD.note_analisi_no_eff,
		OLD.altre_difformita,
		OLD.utente_pres,
		OLD.delegato_ragsoc,
		OLD.delegato_indirizzo,
		OLD.data_arrivo,
		OLD.note_esamevisivo_locale,
		OLD.flag_sbocco_tetto,
		OLD.flag_unicig_7129,
		OLD.new1_data_ultima_manu_2,
		OLD.new1_data_ultima_manu_3,
		OLD.new1_data_ultima_anal_2,
		OLD.new1_data_ultima_anal_3,
		OLD.new1_dimp_pres_2,
		OLD.new1_dimp_pres_3,
		OLD.trasf_centr_aut,
		OLD.igni_progressivo,
		OLD.scarico_tetto,
		OLD.scarico_parete,
--		null,
		NEW.utente,
		st_ope,
		current_timestamp
	);
END IF;
  return new;
end;
' language 'plpgsql';
create trigger trig_coimcimp_st after update on coimcimp
for each row
execute procedure coimcimp_st_tr ();
