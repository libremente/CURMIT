drop trigger trig_coimdimp_st on coimdimp;
create or replace function coimdimp_st_tr() returns trigger
as '
declare
st_ope coimdimp_st.st_operazione%TYPE;
begin
IF (TG_OP = ''DELETE'') THEN
	 st_ope := ''C'';
 END IF;
IF (TG_OP = ''UPDATE'') THEN
	 st_ope := ''M'';
 END IF;

--
IF (TG_OP = ''UPDATE'') or  (TG_OP = ''DELETE'') THEN 
insert into coimdimp_st (
		cod_dimp, 
		cod_impianto, 
		data_controllo, 
		gen_prog, 
		cod_manutentore, 
		cod_responsabile, 
		cod_proprietario, 
		cod_occupante, 
		cod_documento, 
		flag_status, 
		garanzia, 
		conformita, 
		lib_impianto, 
		lib_uso_man, 
		inst_in_out, 
		idoneita_locale, 
		ap_ventilaz, 
		ap_vent_ostruz, 
		pendenza, 
		sezioni, 
		curve, 
		lunghezza, 
		conservazione, 
		scar_ca_si, 
		scar_parete, 
		riflussi_locale, 
		assenza_perdite, 
		pulizia_ugelli, 
		antivento, 
		scambiatore, 
		accens_reg, 
		disp_comando, 
		ass_perdite, 
		valvola_sicur, 
		vaso_esp, 
		disp_sic_manom, 
		organi_integri, 
		circ_aria, 
		guarn_accop, 
		assenza_fughe, 
		coibentazione, 
		eff_evac_fum, 
		cont_rend, 
		pot_focolare_mis, 
		portata_comb_mis, 
		temp_fumi, 
		temp_ambi, 
		o2, 
		co2, 
		bacharach, 
		co, 
		rend_combust, 
		osservazioni, 
		raccomandazioni, 
		prescrizioni, 
		data_utile_inter, 
		n_prot, 
		data_prot, 
		delega_resp, 
		delega_manut, 
		num_bollo, 
		costo, 
		tipologia_costo, 
		riferimento_pag, 
		utente, 
		data_ins, 
		data_mod, 
		potenza, 
		flag_pericolosita, 
		flag_co_perc, 
		flag_tracciato, 
		cod_docu_distinta, 
		scar_can_fu, 
		tiraggio, 
		ora_inizio, 
		ora_fine, 
		rapp_contr, 
		rapp_contr_note, 
		certificaz, 
		certificaz_note, 
		dich_conf, 
		dich_conf_note, 
		libretto_bruc, 
		libretto_bruc_note, 
		prev_incendi, 
		prev_incendi_note, 
		lib_impianto_note, 
		ispesl, 
		ispesl_note, 
		data_scadenza, 
		num_autocert, 
		esame_vis_l_elet, 
		funz_corr_bruc, 
		lib_uso_man_note, 
		volimetria_risc, 
		consumo_annuo, 
		cod_opmanu,
		utente_ins,
		data_arrivo_ente,
		fl_firma_tecnico,
		fl_firma_resp,
		igni_progressivo,
		--st_progressivo, 
		st_utente, 
		st_operazione, 
		st_data_validita,
                cod_opmanu_new
	)
	values (
		OLD.cod_dimp, 
		OLD.cod_impianto, 
		OLD.data_controllo, 
		OLD.gen_prog, 
		OLD.cod_manutentore, 
		OLD.cod_responsabile, 
		OLD.cod_proprietario, 
		OLD.cod_occupante, 
		OLD.cod_documento, 
		OLD.flag_status, 
		OLD.garanzia, 
		OLD.conformita, 
		OLD.lib_impianto, 
		OLD.lib_uso_man, 
		OLD.inst_in_out, 
		OLD.idoneita_locale, 
		OLD.ap_ventilaz, 
		OLD.ap_vent_ostruz, 
		OLD.pendenza, 
		OLD.sezioni, 
		OLD.curve, 
		OLD.lunghezza, 
		OLD.conservazione, 
		OLD.scar_ca_si, 
		OLD.scar_parete, 
		OLD.riflussi_locale, 
		OLD.assenza_perdite, 
		OLD.pulizia_ugelli, 
		OLD.antivento, 
		OLD.scambiatore, 
		OLD.accens_reg, 
		OLD.disp_comando, 
		OLD.ass_perdite, 
		OLD.valvola_sicur, 
		OLD.vaso_esp, 
		OLD.disp_sic_manom, 
		OLD.organi_integri, 
		OLD.circ_aria, 
		OLD.guarn_accop, 
		OLD.assenza_fughe, 
		OLD.coibentazione, 
		OLD.eff_evac_fum, 
		OLD.cont_rend, 
		OLD.pot_focolare_mis, 
		OLD.portata_comb_mis, 
		OLD.temp_fumi, 
		OLD.temp_ambi, 
		OLD.o2, 
		OLD.co2, 
		OLD.bacharach, 
		OLD.co, 
		OLD.rend_combust, 
		OLD.osservazioni, 
		OLD.raccomandazioni, 
		OLD.prescrizioni, 
		OLD.data_utile_inter, 
		OLD.n_prot, 
		OLD.data_prot, 
		OLD.delega_resp, 
		OLD.delega_manut, 
		OLD.num_bollo, 
		OLD.costo, 
		OLD.tipologia_costo, 
		OLD.riferimento_pag, 
		OLD.utente, 
		OLD.data_ins, 
		OLD.data_mod, 
		OLD.potenza, 
		OLD.flag_pericolosita, 
		OLD.flag_co_perc, 
		OLD.flag_tracciato, 
		OLD.cod_docu_distinta, 
		OLD.scar_can_fu, 
		OLD.tiraggio, 
		OLD.ora_inizio, 
		OLD.ora_fine, 
		OLD.rapp_contr, 
		OLD.rapp_contr_note, 
		OLD.certificaz, 
		OLD.certificaz_note, 
		OLD.dich_conf, 
		OLD.dich_conf_note, 
		OLD.libretto_bruc, 
		OLD.libretto_bruc_note, 
		OLD.prev_incendi, 
		OLD.prev_incendi_note, 
		OLD.lib_impianto_note, 
		OLD.ispesl, 
		OLD.ispesl_note, 
		OLD.data_scadenza, 
		OLD.num_autocert, 
		OLD.esame_vis_l_elet, 
		OLD.funz_corr_bruc, 
		OLD.lib_uso_man_note, 
		OLD.volimetria_risc, 
		OLD.consumo_annuo,
		OLD.cod_opmanu,
		OLD.utente_ins,
		OLD.data_arrivo_ente,
		OLD.fl_firma_tecnico,
		OLD.fl_firma_resp,
		OLD.igni_progressivo, 
		--st_progressivo, 
		NEW.utente, 
		st_ope, 
		current_timestamp,
                OLD.cod_opmanu_new
	);
END IF;
  return new;
end;
' language 'plpgsql';
create trigger trig_coimdimp_st after update on coimdimp
for each row
execute procedure coimdimp_st_tr ();
 

